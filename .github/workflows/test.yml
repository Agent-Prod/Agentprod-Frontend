name: Test Server CI/CD

on:
  push:
    branches: [test-deploy]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64, test]
    env:
      NEXT_PUBLIC_APOLLO_API_KEY: ${{ secrets.APOLLO_API_KEY }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
      NEXT_PUBLIC_LOCAL_SERVER: ${{ secrets.NEXT_PUBLIC_LOCAL_SERVER }}
      NEXT_PUBLIC_RAZORPAY_API_KEY: ${{ secrets.NEXT_PUBLIC_RAZORPAY_API_KEY }}
      NEXT_PUBLIC_SERVER_URL: ${{ secrets.NEXT_PUBLIC_TEST_URL }}
      RAZORPAY_API_SECRET_KEY: ${{ secrets.RAZORPAY_API_SECRET_KEY }}

    steps:
      - uses: actions/checkout@v3
        with:
          clean: true

      - name: Cache Next.js build
        uses: actions/cache@v3
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: Install dependencies
        run: npm ci

      - name: Build the app
        if: success()
        run: npm run build

      - name: Deploy and reload PM2
        if: success()
        run: |
          # Check if PM2 process exists
          if pm2 show test-app > /dev/null 2>&1; then
            # If exists, reload with zero downtime
            pm2 reload test-app --update-env --wait-ready
          else
            # If not exists, start in cluster mode
            pm2 start npm --name "test-app" -i max --wait-ready -- start
          fi

          # Wait for new instances to be ready
          sleep 10

      - name: Health check
        if: success()
        run: |
          if ! pm2 pid test-app > /dev/null; then
            echo "Health check failed - process not running"
            exit 1
          fi

      - name: Save PM2 configuration
        if: success()
        run: pm2 save

      - name: Display process status
        if: always()
        run: |
          echo "Current PM2 process list:"
          pm2 list
          echo "Detailed status of test-app:"
          pm2 show test-app
